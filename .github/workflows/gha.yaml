
on: [push]
# TODO: Run build steps in parallel?
# TODO: Automatically update the kernel submodul
name: Linux mm selftests in virtme-ng
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code with submodules
        uses: actions/checkout@v4
        with:
          submodules: true

      # Install dependencies for virtme-ng
      - uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          # First group is kernel deps. Second is virtme-ng dep.
          # apparmor is for the aa-teardown thing below.
          # WARNING: When you change this, you need to manually update the
          # version field below.
          packages: |
            build-essential libnuma-dev libcap-dev
            ncurses-dev xz-utils libssl-dev bc flex libelf-dev bison

            qemu-kvm udev iproute2 qemu-system-x86 python3-requests
            coreutils libvirt-clients kbd kmod file rsync zstd udev

            apparmor
          version: 3

      - name: Build rootfs
        run: |
          # Enable mkosi to do userns stuff
          # https://github.com/actions/runner-images/issues/10015#issuecomment-2668163375
          sudo systemctl disable --now apparmor.service
          sudo aa-teardown || true

          mkosi/bin/mkosi

      - name: Build kernel
        run: |
          cd linux/
          ../virtme-ng/vng -b

      - name: Build mm selftests
        run: |
          cd linux
          make -j headers
          # -static is a simple way to workaround differences in the shared
          # library environment between host & guest.
          make -j $(( $(nproc) * 2 )) -C tools/testing/selftests TARGETS=mm KDIR=$PWD EXTRA_CFLAGS=-static install

      # TODO: Run it
      # TODO: Create reproducer command